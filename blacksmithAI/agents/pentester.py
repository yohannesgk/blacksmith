from .base import init_model
from langchain.agents import create_agent
from datetime import datetime
import json
import logging
from langchain.agents.middleware import TodoListMiddleware, ToolRetryMiddleware
from tools.tools import pentest_shell, shell_documentation
from deepagents import CompiledSubAgent

# fetch tool header from config
available_tools = [json.load(open("./config.json", "r"))['tools']]
available_tools.extend([shell_documentation])

today = datetime.now().strftime("%Y-%m-%d")

# setup logging
logger = logging.getLogger('pentester')
logger.setLevel(logging.INFO)

instrctions = """
You are a pentest agent tasked with providing comprehensive penetration testing methods, answering detailed questions about security testing, and analyzing penetration testing reports. As the central brain for penetration testing operations, you should:

1. Provide detailed penetration testing methodologies and techniques
2. Answer comprehensive questions about security vulnerabilities and testing approaches
3. Analyze and interpret penetration testing reports with expert insights
4. Offer strategic guidance on security assessment and vulnerability identification
5. Assist with penetration testing inquiries and provide technical expertise
6. Document all actions with timestamps for audit and tracking purposes

Use the following tools as needed: {available_tools}
Use the shell documentation tool to search for pentest tools usage and examples.
Make sure to log the date and time of each action you take. today is {today}.
"""

class PentestAgent:
    def __init__(self):

        # initialize model
        model = init_model().get_model()

        #code_interpreter_tool = code_executor()
        #tools = code_interpreter_tool.extend([pentest_shell])

        self.agent = create_agent(
            model=model,
            tools=[pentest_shell, shell_documentation],
            system_prompt=instrctions.format(available_tools=available_tools, today=today),
            name='pentest_agent',
            middleware=[
                TodoListMiddleware(),
                ToolRetryMiddleware(
                    max_retries=3,
                    on_failure="continue"
                ),
            ],

        )

        logger.info("Pentest Agent initialized.")

    def get_agent(self):
        return self.agent
    
    def get_compiled_agent(self) -> CompiledSubAgent:

        compiled_agent = CompiledSubAgent(
            name="pentest_agent",
            description="A comprehensive penetration testing Expert for security assessment, vulnerability analysis, and strategic guidance. providing comprehensive penetration testing methods, answering detailed questions about security testing, and analyzing penetration testing reports.",
            runnable=self.agent,
        )

        return compiled_agent
