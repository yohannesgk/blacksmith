from langchain_openai import ChatOpenAI
import json
from dotenv import load_dotenv
import os
from langchain.tools import tool
import requests
from langgraph.config import get_stream_writer
from langchain.agents import create_agent
from langgraph.checkpoint.memory import InMemorySaver
from langchain.agents.middleware import SummarizationMiddleware
from langchain.messages import HumanMessage, SystemMessage, AIMessage
from rich import print
from rich.console import Console
from deepagents import create_deep_agent, CompiledSubAgent

load_dotenv()

config = json.load(open("config.json", "r"))
console = Console()

# select provider
base_url = config['provider']['openrouter']['base_url'] # default openrouter
api_key = os.getenv("OPENROUTER_API_KEY", "") # get key from env
# init model

model = ChatOpenAI(
    name='pentester_nmap',
    model="mistralai/devstral-2512:free",
    api_key=api_key,
    base_url=base_url,
    stream_usage=True,
    max_retries=5,
    profile={"max_input_tokens": 200000},
)

#response = model.invoke("how are you?")
#print(response)

#define nmap tool

@tool
def pentest_shell(command: str):
    """
    This tool run a shell commands for pentesting.
    You can install new tools that would help you pentest.
    As of now these tools are available [nmap nikto curl hping3 whois dig nslookup dnsrecon dirb sqlmap hydra john gobuster wpscan hydra] besides basic linux commands.
    
    Args:
        command: bash command e.g nmap -sV -p 80,21 10.10.1.173
    """

    writer = get_stream_writer()
    writer(f"running command {command}")

    response = requests.post(
        os.getenv('container_uri', 'http://localhost:9756/exec'),
        json={"cmd": command}
    )
    return response.json()

pentester_agent = create_agent(
    model=model,
    tools=[pentest_shell],
    system_prompt="you are a penetration tester. testing systems and devices using the tools provided.",
    checkpointer=InMemorySaver(),
    name='pentester_agent',
    middleware= [
        SummarizationMiddleware(
          model=model,
          trigger=("fraction", 0.8), 
        )
    ]
)


dp = create_deep_agent(
    base_agent=pentester_agent,
    name="pentester_deep_agent",
    sub_agents=[
        CompiledSubAgent(
            name="recon_agent",
            description="""
                You are a pentester and control a Linux sandbox. You may install packages, run system commands, and perform tests. 
                You are encourged to run and analyze complex commands that would help in executing users task.
                The user might request long running tasks that may require complex execution, timing and analysis. 
                your task is help the user in the best possible way for penetration testing tasks.""",
            runnable=pentester_agent,
        )
    ],
)


config = {'configurable': {'thread_id': 'convo_1'}}

import time

print("----- wellcome to agent portal -------")
print("loading...............................")

while True:

    time.sleep(2)

    try:
        user_input = str(console.input("\n[bold green]message to agent > [/bold green]"))
    except KeyboardInterrupt:
        print("\n[bold red]exiting...[/bold red]")
        time.sleep(3)
        break

    if user_input == 'exit':
        break

    for mode, chunk in pentester_agent.stream({'messages': [HumanMessage(user_input)]}, config=config, stream_mode=['values', 'custom']):

        if mode == 'values':
            chunk['messages'][-1].pretty_print()
        if mode == 'custom':
            print(f"[bold blue]{chunk}[/bold blue]", end='', flush=True)

    
