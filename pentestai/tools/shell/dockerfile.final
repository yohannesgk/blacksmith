# Use the fresh, small Kali base again
FROM kalilinux/kali-rolling

# 1. Install RUNTIME packages only (REMOVE build tools!)
RUN apt update && apt install -y \
    python3 python3-pip \
    nmap masscan \
    whois dnsutils dnsrecon \
    hydra medusa ncrack john \
    gobuster wpscan sslscan \
    netcat-traditional socat \
    hping3 openssh-client \
    perl ruby \
    enum4linux-ng samba-common-bin smbclient \
    httpie \
    trufflehog python3-flask python3-impacket \
    && apt autoremove -y \
    && apt clean \
    && rm -rf /var/lib/apt/lists/*

# 2. COPY THE COMPILED BINARIES FROM YOUR EXISTING IMAGE
# This is the key step. It extracts just the final programs.
COPY --from=mini-kali:latest /usr/local/bin/assetfinder /usr/local/bin/
COPY --from=mini-kali:latest /usr/local/bin/subfinder /usr/local/bin/
COPY --from=mini-kali:latest /usr/local/bin/nuclei /usr/local/bin/

# 3. Set up symlinks and finalize
RUN ln -sf /usr/bin/psexec.py /usr/local/bin/psexec 2>/dev/null || true \
    && ln -sf /usr/bin/secretsdump.py /usr/local/bin/secretsdump 2>/dev/null || true

WORKDIR /app
COPY server.py server_async.py requirements.txt /app/
RUN pip3 install --break-system-packages --no-cache-dir -r requirements.txt

# Download Nuclei templates during build
RUN nuclei -update-templates

EXPOSE 9756
CMD ["python3", "server_async.py"]